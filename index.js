// Generated by LiveScript 1.2.0
(function(){
  var host, linksRef;
  host = "http://localhost:3000";
  $('#submit-form').toggle();
  linksRef = new PgBase(host + "/links");
  window.LINK2ITEM = function(link){
    return "<div class=\"item\">\n  <div class=\"right floated tiny teal\">" + moment(link.create_date).fromNow() + "</div>\n  <div class=\"content\">\n    <a class=\"header link-click\" data-id=\"" + link._id + "\">" + link.title + "</a>\n    <div class=\"description\">\n      <i class=\"red arrow up icon\" class=\"up\" data-id=\"" + link._id + "\"></i>\n      " + link.rating + "\n      " + link.url + "\n      </div>\n  </div>\n</div>";
  };
  window.GET_COMMENT = function(link_id, cb){
    var socketRef;
    socketRef = new PgBase(host + "/comments");
    socketRef.needConnection();
    return socketRef.socket.emit("GET:comments", {
      q: "{\"link_id\":" + link_id + "}"
    }, function(it){
      return cb(it);
    });
  };
  window.INCR_VOTE = function(link_id, cb){
    var linkRef;
    linkRef = new PgBase(host + "/links/" + link_id);
    console.log(linkRef);
    return linkRef.once('value', function(it){
      console.log(it);
      return linkRef.update({
        rating: it.rating + 1
      }, function(it){
        return console.log('done', it);
      });
    });
  };
  linksRef.on('value', function(it){
    var i$, ref$, len$, link;
    $("#link-list").html("");
    for (i$ = 0, len$ = (ref$ = it.reverse()).length; i$ < len$; ++i$) {
      link = ref$[i$];
      $('#link-list').append(LINK2ITEM(link));
    }
    return console.log('value', it);
  });
  linksRef.on('child_added', function(it){
    $('#link-list').prepend(LINK2ITEM(it));
    return console.log('added', it);
  });
  $(function(){
    $('#show-submit').on('click', function(){
      return $('#submit-form').toggle();
    });
    $('#go-to-hot').on('click', function(){
      return $('#submit-form').hide();
    });
    $('#submit-button').on('click', function(){
      var link;
      link = {
        title: $('#submit-title').val(),
        url: $('#submit-link').val(),
        rating: 0
      };
      linksRef.push(link);
      $('#submit-title').val("");
      return $('#submit-link').val("");
    });
    $('body').on('click', '.up', function(it){
      console.log($(it.target).data('id'));
      return INCR_VOTE($(it.target).data('id'), function(){
        return console.log('inc-complete');
      });
    });
    $('body').on('keypress', '#comment-input', function(it){
      var commentRef, link_id, link_body, new_comment;
      if (it.keyCode === 13) {
        commentRef = new PgBase(host + "/comments");
        link_id = $(it.target).data('link-id');
        link_body = $(it.target).val();
        new_comment = {
          link_id: link_id,
          body: link_body
        };
        $(it.target).val("");
        return commentRef.push(new_comment, function(){
          return $('#comment-sect').prepend("<div class=\"ui secondary segment\">\n  <p>" + link_body + "</p>\n</div>");
        });
      }
    });
    return $('body').on('click', '.link-click', function(it){
      var id, postRef;
      id = $(it.target).data("id");
      console.log(id);
      postRef = new PgBase(host + "/links/" + id);
      return postRef.once('value', function(it){
        console.log(it);
        $('#main').html("<h2 class=\"ui header\">\n" + it.title + "\n<div class=\"sub header\"><i class=\"arrow up icon\"></i>\n        " + it.rating + "\n        " + it.url + "\n            </div>\n    </h2>\n    <div class=\"ui input focus fluid icon\">\n      <input type=\"text\" placeholder=\"Leave comment...\" id=\"comment-input\" data-link-id=\"" + it._id + "\">\n      <i class=\"outline comment icon\"></i>\n    </div>\n  </div>\n</div>\n<div id=\"comment-sect\" style=\"padding-top: 20px\"></div>");
        return GET_COMMENT(id, function(it){
          var i$, ref$, len$, c, results$ = [];
          console.log(it);
          for (i$ = 0, len$ = (ref$ = it.entries.reverse()).length; i$ < len$; ++i$) {
            c = ref$[i$];
            results$.push($('#comment-sect').append("<div class=\"ui secondary segment\">\n  </h3>\n  <p>" + c.body + "</p>\n</div>"));
          }
          return results$;
        });
      });
    });
  });
}).call(this);
